# 1. Give your workflow a name
name: CI & CD - Build, Check, and Deploy

# 2. Define your triggers
on:
  push:
    branches: [ "main" ] # Runs on merge to main
  pull_request:
    branches: [ "main" ] # Runs on pull requests to main

# 3. Define the jobs
jobs:
  before-script:
    - export GITHUB_REPOSITORY=$(echo "$github.repository" | tr '[:upper:]' '[:lower:]')
  # ---------------------------------------------
  # JOB 1: The CI "Check"
  # This job runs on BOTH pull requests and pushes
  # ---------------------------------------------
  build-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: docker compose build

  # ---------------------------------------------
  # JOB 2: The CD "Deploy"
  # This job pushes your images to the registry
  # ---------------------------------------------
  deploy-to-ghcr:
    # ⭐️ This job only runs if 'build-and-check' succeeds
    needs: build-and-check

    # ⭐️ This job only runs on a PUSH (merge), not a PR
    if: github.event_name == 'push'

    runs-on: ubuntu-latest

    # ⭐️ Give the job permissions to write to GHCR
    permissions:
      contents: read
      packages: write # This is the key permission

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # This token is auto-generated

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./portal-backend
          push: true
          # Tags the image with 'ghcr.io/YOUR_USERNAME/portal-backend:latest'
          tags: ghcr.io/${{ GITHUB_REPOSITORY }}/portal-backend:latest

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./portal-frontend
          push: true
          # Tags the image with 'ghcr.io/YOUR_USERNAME/portal-frontend:latest'
          tags: ghcr.io/${{ GITHUB_REPOSITORY }}/portal-frontend:latest