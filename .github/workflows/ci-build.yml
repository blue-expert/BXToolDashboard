# 1. Give your workflow a name
name: CI & CD - Build, Check, and Deploy

# 2. Define your triggers
on:
  push:
    branches: [ "main" ] # Runs on merge to main
  pull_request:
    branches: [ "main" ] # Runs on pull requests to main

# 3. Define the jobs
jobs:
  # ---------------------------------------------
  # JOB 1: The CI "Check"
  # This job runs on BOTH pull requests and pushes
  # ---------------------------------------------
  build-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: docker compose build


  # ---------------------------------------------
  # JOB 2: The CD "Deploy"
  # ---------------------------------------------
  deploy-to-ghcr:
    needs: build-and-check
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./portal-backend
          push: true
          # ⭐️ FIX: Build the tag from two lowercase parts
          tags: ghcr.io/${{ toLower(github.repository_owner) }}/${{ toLower(github.repository.name) }}/portal-backend:latest

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./portal-frontend
          push: true
          # ⭐️ FIX: Build the tag from two lowercase parts
          tags: ghcr.io/${{ toLower(github.repository_owner) }}/${{ toLower(github.repository.name) }}/portal-frontend:latest